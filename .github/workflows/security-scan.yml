name: Weekly Security Scan

on:
  schedule:
    # Run every Monday at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:  # Allow manual triggers

permissions:
  contents: read
  issues: write

jobs:
  security-scan:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout ðŸ›Žï¸
        uses: actions/checkout@v4

      - name: Set up Python ðŸ
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies ðŸ“¦
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          pip install -r requirements-dev.txt

      - name: Run pip-audit ðŸ”
        id: pip-audit
        continue-on-error: true
        run: |
          pip-audit --format json > pip-audit-report.json || true
          pip-audit

      - name: Run Bandit ðŸ”’
        id: bandit
        continue-on-error: true
        run: |
          bandit -r . -f json -o bandit-report.json -ll --skip B101 -x .venv,venv,build,dist,.eggs || true
          bandit -r . -ll --skip B101 -x .venv,venv,build,dist,.eggs

      - name: Run Safety ðŸ›¡ï¸
        id: safety
        continue-on-error: true
        run: |
          safety check --json > safety-report.json || true
          safety check

      - name: Upload scan results ðŸ“Š
        uses: actions/upload-artifact@v3
        with:
          name: security-scan-reports
          path: |
            pip-audit-report.json
            bandit-report.json
            safety-report.json

      - name: Create issue if vulnerabilities found ðŸš¨
        if: steps.pip-audit.outcome == 'failure' || steps.bandit.outcome == 'failure' || steps.safety.outcome == 'failure'
        uses: actions/github-script@v6
        with:
          script: |
            const title = 'ðŸ”’ Security Scan Alert - ' + new Date().toISOString().split('T')[0];
            const body = `## Security Scan Results
            
            A scheduled security scan has detected potential issues.
            
            ### Scan Results
            - **pip-audit**: ${{ steps.pip-audit.outcome }}
            - **Bandit**: ${{ steps.bandit.outcome }}
            - **Safety**: ${{ steps.safety.outcome }}
            
            ### Action Required
            1. Review the [workflow run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            2. Download the security reports from artifacts
            3. Address any critical or high-severity issues
            4. Update dependencies if needed
            
            ### Resources
            - [SECURITY.md](https://github.com/${{ github.repository }}/blob/main/SECURITY.md)
            - [Scan Artifacts](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            `;
            
            github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: ['security', 'automated']
            });
